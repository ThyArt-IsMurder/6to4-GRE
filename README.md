# تانل 6to4 GRE

تانل 6to4 GRE یک روش تانل است که برای انتقال بسته‌های IPv6 بر روی یک شبکه IPv4 با استفاده از پروتکل GRE (Generic Routing Encapsulation) به کار می‌رود. در واقع، این روش دو تکنولوژی را با هم ترکیب می‌کند:

* **تعریف 6to4:** یک مکانیزم انتقال IPv6 است که به شبکه‌های IPv6 ایزوله شده اجازه می‌دهد تا از طریق اینترنت IPv4 با یکدیگر ارتباط برقرار کنند. این کار با اختصاص یک پیشوند آدرس IPv6 خاص (`2002::/16`) انجام می‌شود که آدرس IPv4 عمومی روتر مرزی در آن گنجانده شده است.
* **تعریف GRE (Generic Routing Encapsulation):** پروتکلی است که امکان کپسوله‌کردن انواع مختلفی از بسته‌های پروتکل شبکه را درون یک پروتکل دیگر (معمولاً IP) فراهم می‌کند. به عبارت دیگر، GRE یک "پوشش" برای بسته‌های اصلی ایجاد می‌کند تا بتوانند از طریق شبکه‌ای که مستقیماً از پروتکل اصلی پشتیبانی نمی‌کند، عبور کنند.

## تانل 6to4 GRE چگونه کار می‌کند؟

1.  بسته‌های IPv6 که نیاز به ارسال از طریق شبکه IPv4 دارند، ابتدا توسط مکانیزم 6to4 پردازش می‌شوند.
2.  سپس این بسته‌های IPv6 (که حالا دارای آدرس‌های 6to4 هستند) توسط پروتکل GRE کپسوله می‌شوند. این به این معناست که یک هدر GRE به بسته IPv6 اضافه می‌شود.
3.  در نهایت، بسته GRE کپسوله‌شده، خود درون یک بسته IPv4 قرار می‌گیرد تا بتواند در شبکه IPv4 مسیریابی شود.
4.  در سمت دیگر تونل (مقصد)، فرآیند به صورت معکوس انجام می‌شود: ابتدا هدر IPv4، سپس هدر GRE حذف شده و بسته IPv6 اصلی بازیابی و به مقصد نهایی خود ارسال می‌شود.

## کاربردهای اصلی تانل 6to4 GRE

* **اتصال جزایر IPv6 از طریق شبکه IPv4:** این روش به سازمان‌ها یا کاربرانی که دارای شبکه‌های داخلی مبتنی بر IPv6 هستند اما تنها از طریق یک شبکه IPv4 به اینترنت یا سایر شبکه‌ها متصل هستند، اجازه می‌دهد تا ترافیک IPv6 خود را منتقل کنند.
* **انتقال ترافیک IPv6 بین روترها:** مدیران شبکه می‌توانند از تانل‌های 6to4 GRE برای ایجاد ارتباطات نقطه به نقطه بین روترهایی که نیاز به تبادل ترافیک IPv6 دارند، استفاده کنند، حتی اگر زیرساخت شبکه بین آن‌ها فقط IPv4 باشد.
* **مهاجرت تدریجی به IPv6:** در طول دوره گذار از IPv4 به IPv6، این نوع تونل‌ها می‌توانند به عنوان یک راه‌حل موقت برای برقراری ارتباطات IPv6 عمل کنند.

## مزایا و معایب

### مزایا:

* **امکان انتقال IPv6 بر روی IPv4:** اصلی‌ترین مزیت آن فراهم کردن راهی برای استفاده از IPv6 در شبکه‌هایی است که هنوز به طور کامل از IPv6 پشتیبانی نمی‌کنند.
* **انعطاف‌پذیری GRE:** پروتکل GRE قادر به کپسوله‌کردن انواع مختلف ترافیک است.
* **عدم نیاز به هماهنگی با ارائه‌دهنده سرویس اینترنت (ISP) برای آدرس‌دهی خاص (نسبت به برخی روش‌های دیگر):** مکانیزم 6to4 از یک پیشوند آدرس استاندارد استفاده می‌کند.

### معایب:

* **افزایش سربار (Overhead):** به دلیل اضافه شدن هدرهای GRE و IPv4، اندازه بسته‌ها افزایش می‌یابد که می‌تواند منجر به کاهش کارایی شود.
* **پیچیدگی در پیکربندی و اشکال‌زدایی:** راه‌اندازی و مدیریت این تونل‌ها می‌تواند نسبت به اتصالات بومی IPv6 پیچیده‌تر باشد.
* **مسائل مربوط به امنیت و MTU:** مانند سایر روش‌های تونل‌زنی، ممکن است نیاز به تنظیمات دقیق MTU (Maximum Transmission Unit) و در نظر گرفتن ملاحظات امنیتی باشد (GRE به خودی خود رمزنگاری ارائه نمی‌دهد و معمولاً برای امنیت بیشتر با IPsec ترکیب می‌شود).
* **وابستگی به رله‌های عمومی 6to4 (در برخی سناریوها):** عملکرد و پایداری ارتباطات 6to4 می‌تواند به در دسترس بودن و عملکرد صحیح رله‌های عمومی 6to4 وابسته باشد، که همیشه قابل اعتماد نیستند.

---

در مجموع، تانل 6to4 GRE یک ابزار مفید در جعبه‌ابزار مدیران شبکه برای مدیریت دوره گذار به IPv6 و اتصال شبکه‌های IPv6 پراکنده است، اما باید با در نظر گرفتن مزایا و معایب آن و در مقایسه با سایر روش‌های انتقال IPv6 مورد استفاده قرار گیرد.
# اسکریپت تانل 6to4 GRE 

این اسکریپت برای ایجاد یک تانل 6to4 GRE بین دو سرور (یکی در ایران و دیگری در خارج) استفاده می‌شود. این تانل به شما امکان می‌دهد تا ترافیک خود را از طریق سرور خارجی هدایت کنید.

## پیش‌نیازها

* دو سرور لینوکس (یکی در ایران و دیگری در خارج از ایران)
* دسترسی root یا sudo به هر دو سرور
* آی‌پی عمومی معتبر برای هر دو سرور

## نحوه استفاده

1.  اسکریپت `tunnel_script.sh` را در هر دو سرور دانلود کنید. می‌توانید از دستور زیر برای دانلود و اجرای مستقیم اسکریپت استفاده کنید:
    ```bash
    bash <(curl -sL https://raw.githubusercontent.com/ThyArt-IsMurder/6to4-GRE/refs/heads/main/tunnel_script.sh)
    ```
    یا به صورت دستی:
    *   اسکریپت را دانلود کنید.
    *   به اسکریپت مجوز اجرا بدهید:
        ```bash
        chmod +x tunnel_script.sh
        ```
    *   اسکریپت را در هر سرور اجرا کنید:
        ```bash
        ./tunnel_script.sh
        ```

2.  هنگام اجرای اسکریپت، از شما سوالاتی پرسیده می‌شود:
    *   **Choose which side you are configuring (1/2):** انتخاب کنید که در حال پیکربندی سرور ایران (1) هستید یا سرور خارج (2).
    *   **Enter Foreign Server Public IP:** آی‌پی عمومی سرور خارجی را وارد کنید.
    *   **Enter Iran Server Public IP:** آی‌پی عمومی سرور ایران را وارد کنید.
    *   **Enter desired SSH port to forward (only on Iran side):** (فقط برای سرور ایران) پورت SSH مورد نظر برای فوروارد را وارد کنید. این پورت برای دسترسی به سرور خارجی از طریق تانل استفاده خواهد شد.

### پیکربندی سمت ایران

هنگامی که گزینه `1` را برای سرور ایران انتخاب می‌کنید، اسکریپت تنظیمات زیر را انجام می‌دهد:

*   ایجاد یک تانل SIT به نام `6to4_iran` بین سرور ایران و سرور خارج.
*   اختصاص آدرس IPv6 محلی (`2002:a00:100::1/64`) به اینترفیس `6to4_iran`.
*   فعال‌سازی اینترفیس `6to4_iran`.
*   ایجاد یک تانل GRE6 به نام `GRE6Tun_iran` با استفاده از آدرس‌های IPv6 محلی.
*   اختصاص آدرس IP (`10.10.187.1/30`) به اینترفیس `GRE6Tun_iran`.
*   فعال‌سازی اینترفیس `GRE6Tun_iran`.
*   فعال‌سازی `ip_forward`.
*   تنظیم قوانین `iptables` برای NAT کردن ترافیک SSH به سمت سرور خارجی و MASQUERADE کردن سایر ترافیک‌ها.

### پیکربندی سمت خارج

هنگامی که گزینه `2` را برای سرور خارج انتخاب می‌کنید، اسکریپت تنظیمات زیر را انجام می‌دهد:

*   ایجاد یک تانل SIT به نام `6to4_Forign` بین سرور خارج و سرور ایران.
*   اختصاص آدرس IPv6 محلی (`2002:a00:100::2/64`) به اینترفیس `6to4_Forign`.
*   فعال‌سازی اینترفیس `6to4_Forign`.
*   ایجاد یک تانل GRE6 به نام `GRE6Tun_Forign` با استفاده از آدرس‌های IPv6 محلی.
*   اختصاص آدرس IP (`10.10.187.2/30`) به اینترفیس `GRE6Tun_Forign`.
*   فعال‌سازی اینترفیس `GRE6Tun_Forign`.

## نکات مهم

*   این اسکریپت تنظیمات را در فایل `/etc/rc.local` ذخیره می‌کند تا پس از راه‌اندازی مجدد سرور، تانل به صورت خودکار برقرار شود. 
*   پس از اجرای اسکریپت، ممکن است نیاز به راه‌اندازی مجدد سرور یا اجرای دستی `/etc/rc.local` داشته باشید. 
*   مطمئن شوید که فایروال سرورها اجازه عبور ترافیک مورد نیاز برای تانل‌ها (SIT و GRE) را می‌دهد.
*   سرورها باید تمیز باشند و آی‌پی لوکال در سرور شما مسدود نباشد. 
*   داشتن آی‌پی ورژن 6 اصلاً مهم نیست، اسکریپت خودش آن را می‌سازد. 
*   اگر سرور ریستارت شود، تانل از کار می‌افتد و اسکریپت را باید مجدداً اجرا کنید (مگر اینکه `rc.local` به درستی تنظیم شده باشد). 
*   این تانل تمامی پورت‌ها را بصورت یکجا تانل می‌کند و نیازی به وارد کردن پورت خاصی نیست (به جز پورت SSH برای فورواردینگ اولیه در سمت ایران). 

